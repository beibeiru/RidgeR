#!/bin/sh

# Detect GSL
if command -v gsl-config > /dev/null 2>&1; then
  GSL_CFLAGS=$(gsl-config --cflags)
  GSL_LIBS=$(gsl-config --libs)
else
  echo "ERROR: gsl-config not found. Please install GSL."
  echo "  macOS:  brew install gsl"
  echo "  Linux:  sudo apt-get install libgsl-dev  (or yum install gsl-devel)"
  exit 1
fi

# Get R's CC
CC=$("${R_HOME}/bin/R" CMD config CC 2>/dev/null || echo "cc")

# Detect OpenMP support
OPENMP_CFLAGS=""
OPENMP_LIBS=""

case "$(uname -s)" in
  Darwin)
    # macOS: Apple Clang needs -Xclang -fopenmp and libomp
    if [ -d "/opt/homebrew/opt/libomp" ]; then
      LIBOMP_PREFIX="/opt/homebrew/opt/libomp"
    elif [ -d "/usr/local/opt/libomp" ]; then
      LIBOMP_PREFIX="/usr/local/opt/libomp"
    else
      LIBOMP_PREFIX=""
    fi
    if [ -n "$LIBOMP_PREFIX" ]; then
      # Test-compile to verify the OpenMP runtime is compatible
      OMP_TEST_CFLAGS="-Xclang -fopenmp -I${LIBOMP_PREFIX}/include"
      OMP_TEST_LIBS="-L${LIBOMP_PREFIX}/lib -lomp"
      cat > /tmp/_ridger_omp_test.c <<EOTEST
#include <omp.h>
int main() {
  int n = omp_get_max_threads();
  #pragma omp parallel for
  for (int i = 0; i < n; i++) { }
  return 0;
}
EOTEST
      if ${CC} ${OMP_TEST_CFLAGS} ${OMP_TEST_LIBS} /tmp/_ridger_omp_test.c \
           -o /tmp/_ridger_omp_test 2>/dev/null \
         && /tmp/_ridger_omp_test 2>/dev/null; then
        OPENMP_CFLAGS="${OMP_TEST_CFLAGS}"
        OPENMP_LIBS="${OMP_TEST_LIBS}"
      else
        echo "NOTE: OpenMP test-compile failed. Building without OpenMP (single-threaded)."
        echo "  Multi-threading is optional; all functions work without it."
      fi
      rm -f /tmp/_ridger_omp_test.c /tmp/_ridger_omp_test
    else
      echo "NOTE: libomp not found. Building without OpenMP (single-threaded)."
      echo "  To enable multi-threading: brew install libomp"
    fi
    ;;
  *)
    # Linux / other: gcc supports -fopenmp natively
    OPENMP_CFLAGS="-fopenmp"
    OPENMP_LIBS="-fopenmp"
    ;;
esac

# Generate Makevars from template
sed -e "s|@GSL_CFLAGS@|${GSL_CFLAGS}|g" \
    -e "s|@GSL_LIBS@|${GSL_LIBS}|g" \
    -e "s|@OPENMP_CFLAGS@|${OPENMP_CFLAGS}|g" \
    -e "s|@OPENMP_LIBS@|${OPENMP_LIBS}|g" \
    src/Makevars.in > src/Makevars

echo "Configuration complete."
echo "  GSL_CFLAGS:    ${GSL_CFLAGS}"
echo "  GSL_LIBS:      ${GSL_LIBS}"
echo "  OPENMP_CFLAGS: ${OPENMP_CFLAGS:-<disabled>}"
echo "  OPENMP_LIBS:   ${OPENMP_LIBS:-<disabled>}"
