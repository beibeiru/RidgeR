#!/bin/sh

# Detect GSL
if command -v gsl-config > /dev/null 2>&1; then
  GSL_CFLAGS=$(gsl-config --cflags)
  GSL_LIBS=$(gsl-config --libs)
else
  echo "ERROR: gsl-config not found. Please install GSL."
  echo "  macOS:  brew install gsl"
  echo "  Linux:  sudo apt-get install libgsl-dev  (or yum install gsl-devel)"
  exit 1
fi

# Get R's CC
CC=$("${R_HOME}/bin/R" CMD config CC 2>/dev/null || echo "cc")

# Detect OpenMP support
OPENMP_CFLAGS=""
OPENMP_LIBS=""

case "$(uname -s)" in
  Darwin)
    # macOS: Apple Clang + Homebrew libomp has known runtime incompatibilities
    # (e.g. missing ___kmpc_dispatch_deinit with clang 17). Disable OpenMP;
    # all functions work single-threaded via #ifdef _OPENMP guards.
    echo "NOTE: macOS detected. Building without OpenMP (single-threaded)."
    ;;
  *)
    # Linux / other: gcc supports -fopenmp natively
    OPENMP_CFLAGS="-fopenmp"
    OPENMP_LIBS="-fopenmp"
    ;;
esac

# Generate Makevars from template
sed -e "s|@GSL_CFLAGS@|${GSL_CFLAGS}|g" \
    -e "s|@GSL_LIBS@|${GSL_LIBS}|g" \
    -e "s|@OPENMP_CFLAGS@|${OPENMP_CFLAGS}|g" \
    -e "s|@OPENMP_LIBS@|${OPENMP_LIBS}|g" \
    src/Makevars.in > src/Makevars

echo "Configuration complete."
echo "  GSL_CFLAGS:    ${GSL_CFLAGS}"
echo "  GSL_LIBS:      ${GSL_LIBS}"
echo "  OPENMP_CFLAGS: ${OPENMP_CFLAGS:-<disabled>}"
echo "  OPENMP_LIBS:   ${OPENMP_LIBS:-<disabled>}"
